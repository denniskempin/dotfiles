#!/bin/bash
set -ex
cd "$(dirname "$0")"

################################################################################
# Common

install_cargo_packages() {
  # Install rustup
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  source $HOME/.cargo/env

  packages=(
    starship # great cross-shell prompt
    zoxide   # better cd (with fuzzy matching and autojump)
    exa      # better ls
    fd-find  # better find
    bat      # better cat
  )
  cargo install --locked "${packages[@]}"
}

setup_fish() {
  # Link config files
  mkdir -p ~/.config/fish/
  ln -sf "$(pwd)/fish/config.fish" ~/.config/fish/config.fish
  ln -sf "$(pwd)/fish/fish_plugins" ~/.config/fish/fish_plugins
  ln -sf "$(pwd)/fish/starship.toml" ~/.config/starship.toml

  # Using fish as a login shell can be problematic since it is not POSIX
  # compliant. So instead we make bash call fish for interactive shells.
  ln -sf "$(pwd)/fish/bashrc" ~/.bash_profile
  ln -sf "$(pwd)/fish/bashrc" ~/.bashrc

  # Install fisher plugins
  fish -c "curl -sL https://git.io/fisher | source && fisher update"
}

################################################################################
# OSX specific

setup_vscode() {
  ln -sf "$(pwd)/vscode/keybindings.json" ~/Library/Application\ Support/Code/User/keybindings.json
  ln -sf "$(pwd)/vscode/settings.json" ~/Library/Application\ Support/Code/User/settings.json
}

setup_iterm2() {
  # Tell iterm2 to use the settings file in `./iterm2`
  defaults write com.googlecode.iterm2.plist PrefsCustomFolder -string "$(pwd)/iterm2"
  defaults write com.googlecode.iterm2.plist LoadPrefsFromCustomFolder -bool true
}

install_osx_packages() {
  if ! command -v brew; then
    echo "Skipping homebrew packages"
    return
  fi
  packages=(
    fish
    thefuck # Corrects common command mistakes (e.g. prepending sudo)
    tldr    # tldr versins of man pages
    grc     # generic colorizer for standard commands
  )
  brew install "${packages[@]}"

  brew tap homebrew/cask-fonts
  brew install --cask \
    font-fira-code
}

setup_osx() {
  install_cargo_packages
  install_osx_packages
  setup_vscode
  setup_iterm2
  setup_fish
}

################################################################################
# Linux specific

install_debian_packages() {
  packages=(
    fish
    thefuck # Corrects common command mistakes (e.g. prepending sudo)
    tldr    # tldr versions of man pages
    grc     # generic colorizer for standard commands
  )
  sudo apt install --yes "${packages[@]}"
}

setup_linux() {
  install_cargo_packages
  install_debian_packages
  setup_fish
}

################################################################################
# Main

main() {
  # Get sudo upfront so we don't need to ask later.
  sudo true

  case $OSTYPE in
  darwin*)
    setup_osx
    ;;
  *)
    setup_linux
    ;;
  esac

}
main
